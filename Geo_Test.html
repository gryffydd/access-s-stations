<!DOCTYPE html>
<html>
<head>
    <title>GeoJSON Example - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

    <style>
            html, body {
                height: 100%;
                margin: 0;
            }
            #map {
                width: 1000px;
                height: 800px;
            }
    </style>

    <script>
        var MARKER = {
            onEachFeature: onEachFeature,
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: "#00FFFF",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.25
                });
            }
        }

        var FEATURE_COLLECTION = {
        
    "type": "FeatureCollection", 
    "features": [
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    115.2861, 
                    -33.6855
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "VASSE", 
                "site_id": "109519"
            }
        }, 
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    150.8611, 
                    -33.8667
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "ABBOTSBURY (FAIRFIELD (CITY FARM))", 
                "site_id": "67114"
            }
        }, 
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    151.1295, 
                    -33.8507
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "ABBOTSFORD (BLACKWALL POINT RD)", 
                "site_id": "66034"
            }
        }, 
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    147.1019, 
                    -43.2256
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "ABELS BAY (SANDREEF ROAD)", 
                "site_id": "94263"
            }
        }, 
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    151.1292, 
                    -25.1333
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "ABERCORN", 
                "site_id": "39000"
            }
        }, 
        {
            "geometry": {
                "type": "Point", 
                "coordinates": [
                    151.1306, 
                    -25.1292
                ]
            }, 
            "type": "Feature", 
            "properties": {
                "site_name": "ABERCORN TM", 
                "site_id": "39319"
            }
        }
    ]
        };

        function lon_to_x (lon) { return Math.floor((lon - 112 + 0.025) * 20); }
        function lat_to_y (lat) { return Math.floor((lat + 44.5 + 0.025) * 20); }
        function range_text(n) { return "[" + n + ":1:" + n + "]"; }
        function date_string () {
            return ((new Date(Date.now() - (3*24*60*60*1000))).toISOString().split("T")[0]).replace(/-/g, "");
        }

        function make_popup (coords) {
            var x = lon_to_x(coords[0]);
            var y = lat_to_y(coords[1]);
            var content = "Lat: " + coords[1] + " - Lon: " + coords[0] + " - Index (x, y): (" + x + ", " + y + ")";
            var fc_date = date_string();
            var fc_var = "pr";
            var href = "http://opendap.bom.gov.au:8080/thredds/dodsC/seasonal_prediction/access-s/atmos";
            href += "/" + fc_var + "/e01/w_daq5_" + fc_var + "_" + fc_date + "_e01.nc.ascii?" + fc_var  + "[0:1:19][" + y + ":1:" + y + "][" + x + ":1:" + x + "]";
            return "<a href=\"" + href + "\" target=\"opendap_" + x + "_" + y + "\">" + content + "</a>";
        }

        function onEachFeature(feature, layer) {
            var popupContent = "Unset";
            if (feature.properties && feature.properties.site_name) {
                layer.bindTooltip(feature.properties.site_name); 
            }
            if (feature.geometry.type && feature.geometry.type == "Point" && feature.geometry.coordinates) {
                popupContent = make_popup(feature.geometry.coordinates);
            }
            layer.bindPopup(popupContent);
        }

        function make_point (x, y) {
            var content = "Lat: " + lat[y] + " - Lon: " + lon[x] + " - Index (x, y): (" + x + ", " + y + ")";
            var href = "http://opendap.bom.gov.au:8080/thredds/dodsC/seasonal_prediction/access-s/atmos/pr/e01/w_daq5_pr_20190816_e01.nc.ascii?pr[0:1:19][" + y + ":1:" + y + "][" + x + ":1:" + x + "]";
            content = "<a href=\"" + href + "\" target=\"opendap_" + x + "_" + y + "\">" + content + "</a>";
            p = {};
            p.type = "Feature";
            p.properties = {"content": content};
            p.geometry = {"type": "Point", "coordinates": [lon[x], lat[y]]};
                return p;
        }

        function load_collection () {
            return FEATURE_COLLECTION;
        }

        function load_collection_dynamic () {
            console.log("Load Collection");
            fetch('ACCESS-S-Stations.json')
            .then(reponse => {
                console.log(reponse);
                if ( ! reponse.ok ) {
                    throw new Error("HTTP error " + response.status);
                }
                console.log("SHOW ME: " + response.body)
                return response.json();
            })
            .then( json => {
                console.log("JSON: " + json);
                L.geoJSON(json, MARKER).addTo(map);
            })
            .catch( function () {
                console.log(this);
            })
        };


	</script>

</head>
<body>
    <div id='map'></div>

    <script>
        // Center on Melbourne
        var map = L.map('map').setView([-38, 145], 6);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
            {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                    '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.light'
            }).addTo(map);

        L.geoJSON(load_collection(), MARKER).addTo(map);

    </script>
</body>
</html>
